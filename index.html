<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Roll Safe Meme Generator</title>

	<script>
		if(parent.frames.length === 0){
			window.location.href = 'https://vk.com/roll_safe_meme';
		}
	</script>

	<script src="https://vk.com/js/api/xd_connection.js?2"></script>
	<script src="https://yastatic.net/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.7.8/fabric.min.js"></script>

	<style>
		* {
			margin: 0;
			padding: 0;
		}
		.hidden {
			display: none;
		}
	</style>

	<script>
		var rights = {
			friends: 2,
			photos: 4,
			wall: 8192
		};
	</script>
</head>
<body>

<canvas id="canvas" height="438" width="795"></canvas>
<img id="original" height="438" width="795" class="hidden" crossOrigin="Anonymous" src="https://pp.userapi.com/c639328/v639328775/11055/jtLpXjAFj1I.jpg">

<button id="wall-post">Запостить на стену</button>

<script>
$(function () { VK.init(function() {
	var top = 'Текст вверху';
	var bottom = 'Текст внизу';

	var canvas = new fabric.Canvas('canvas', {selection: false, preserveObjectStacking: true});
	var imgElement = document.getElementById('original');
	var imgInstance = new fabric.Image(imgElement, {
		left: 0, 
		top: 0,
		hasControls: false,
		hasRotatingPoint: false,
		lockRotation: true,
		lockMovementX: true,
		lockMovementY: true,
		evented: false
	});
	
	var width = 795;
	var height = 438;
	var hCenter = width / 2;

	var options = { 
		width: width,
		fontFamily: 'impact',
		borderColor: 'rgba(0,0,0,1)',
		fill: 'rgb(255,255,255)',
		cursorColor: '#333',
		originX: 'left', 
		originY: 'top',
		centeredRotation: true,
		textAlign: 'center',
		editable: true,
		cursorColor: '#000',
		cursorDuration: 50,
		cursorWidth: 3,
		editingBorderColor: '#666',
		padding: 10
	}

	var topText = new fabric.Textbox(top, options);
	var bottomText = new fabric.Textbox(bottom, options);

	var topPoint = new fabric.Point(hCenter, 50);
	var bottonPoint = new fabric.Point(hCenter, height - 50);

	topText.setPositionByOrigin(topPoint, 'center', 'center');
	bottomText.setPositionByOrigin(bottonPoint, 'center', 'center');

	canvas.add(imgInstance);
	canvas.add(topText);
	canvas.add(bottomText);

	canvas.setActiveObject(topText);
	topText.enterEditing();
	topText.hiddenTextarea.focus();

	function dataURItoBlob(dataURI) {
		var byteString;
		if (dataURI.split(',')[0].indexOf('base64') >= 0)
			byteString = atob(dataURI.split(',')[1]);
		else
			byteString = unescape(dataURI.split(',')[1]);

		// separate out the mime component
		var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

		// write the bytes of the string to a typed array
		var ia = new Uint8Array(byteString.length);
		for (var i = 0; i < byteString.length; i++) {
			ia[i] = byteString.charCodeAt(i);
		}

		return new Blob([ia], {type:mimeString});
	}

	var sendFile = function (url, key, val, callback) {
		var form = new FormData();
		form.append(key, dataURItoBlob(val), 'ololo_image.png');
		$.ajax({
			url : url,
			type : "post",
			data: form,
			processData: false,
			contentType: false,
			success : function(data){
				callback(data);
			}
		});
	}

	var wallPost = function () {
		VK.api('photos.getWallUploadServer', {}, function(server){
			var server = server.response;
			var uploadUrl = 'https://cors-anywhere.herokuapp.com/' + server.upload_url;

			sendFile(uploadUrl, 'photo', canvas.toDataURL('png'), function (data) {
				data.photo = data.photo.replace('\"', '"');

				VK.api('photos.saveWallPhoto', data, function(save){
					var wallParams = { 
						message: 'Ololo!', 
						attachments: save.response[0].id 
					};

					VK.api('wall.post', wallParams, function(wall){

					});
				});
			})
		});
	};

	$(document).on('click', '#wall-post', function () {
		VK.api('account.getAppPermissions', function (data) {
			if (!(data.response & rights.wall)) {
				var onSettingsChanged = function(settings){ 
					if (!(settings & rights.wall)) {
						alert('Очень жаль');
					} else {
						wallPost();
					}
					VK.removeCallback('onSettingsChanged', onSettingsChanged);
				}
				VK.callMethod('showSettingsBox', rights.wall);
				VK.addCallback('onSettingsChanged', onSettingsChanged);
			} else {
				wallPost();
			}
		});
	})


}, function() { window.location.reload(true); }, '5.63');
});
</script>
</body>
</html>