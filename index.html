<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Roll Safe Meme Generator</title>

	<script>
		if(parent.frames.length === 0){
			window.location.href = 'https://vk.com/roll_safe_meme';
		}
	</script>

	<script src="https://vk.com/js/api/xd_connection.js?2"></script>
	<script src="https://yastatic.net/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.7.8/fabric.min.js"></script>

	<style>
		* {
			margin: 0;
			padding: 0;
		}
		.hidden {
			display: none;
		}
	</style>

	<script>
		var rights = {
			friends: 2,
			photos: 4,
			wall: 8192
		};
	</script>
</head>
<body>

<canvas id="canvas" height="438" width="795"></canvas>
<img id="original" height="438" width="795" class="hidden" crossOrigin="Anonymous" src="https://pp.userapi.com/c639328/v639328775/11055/jtLpXjAFj1I.jpg">

<button id="wall-post">Запостить на стену</button>

<script>
$(function () { VK.init(function() {
	var top = 'Текст вверху';
	var bottom = 'Текст внизу';

	var canvas = new fabric.Canvas('canvas', {selection: false, preserveObjectStacking: true});
	var imgElement = document.getElementById('original');
	var imgInstance = new fabric.Image(imgElement, {
		left: 0, 
		top: 0,
		hasControls: false,
		hasRotatingPoint: false,
		lockRotation: true,
		lockMovementX: true,
		lockMovementY: true,
		evented: false
	});
	
	var width = 795;
	var height = 438;
	var hCenter = width / 2;

	var options = { 
		width: width,
		fontFamily: 'impact',
		borderColor: 'rgba(0,0,0,1)',
		fill: 'rgb(255,255,255)',
		cursorColor: '#333',
		originX: 'left', 
		originY: 'top',
		centeredRotation: true,
		textAlign: 'center',
		editable: true,
		cursorColor: '#000',
		cursorDuration: 50,
		cursorWidth: 3,
		editingBorderColor: '#666',
		padding: 10
	}

	var topText = new fabric.Textbox(top, options);
	var bottomText = new fabric.Textbox(bottom, options);

	var topPoint = new fabric.Point(hCenter, 50);
	var bottonPoint = new fabric.Point(hCenter, height - 50);

	topText.setPositionByOrigin(topPoint, 'center', 'center');
	bottomText.setPositionByOrigin(bottonPoint, 'center', 'center');

	canvas.add(imgInstance);
	canvas.add(topText);
	canvas.add(bottomText);

	canvas.setActiveObject(topText);
	topText.enterEditing();
	topText.hiddenTextarea.focus();

	var sendFile = function (url, key, val, callback) {
		var boundary = 'OLOLO';
		var boundaryMiddle = '--' + boundary + '\r\n';
		var boundaryLast = '--' + boundary + '--\r\n'

		var body = [
			'\r\n',
			'Content-Disposition: form-data; name="' + key + '"; filename="ololopic.png"',
			'Content-Type: image/png',
			'\r\n',
			val
		];

		var allBody = boundaryMiddle + body.join('') + boundaryLast;

		var XHR = ("onload" in new XMLHttpRequest()) ? XMLHttpRequest : XDomainRequest;
		var xhr = new XHR();
		xhr.open('POST', url, true);

		xhr.setRequestHeader('Content-Type', 'multipart/form-data; boundary=' + boundary);

		xhr.onreadystatechange = function() {
			if (this.readyState != 4) return;
			callback(JSON.parse(xhr.responseText));
		}

		xhr.send(allBody);
	}

	var wallPost = function () {
		VK.api('photos.getWallUploadServer', {}, function(server){
			var server = server.response;

			sendFile(server.upload_url, 'photo', canvas.toDataURL('png'), function (data) {
				VK.api('photos.saveWallPhoto', data.photo, function(save){
					VK.api('wall.post', { message: data.message, attachments: save.response[0].id }, function(wall){

					});
				});
			})
		});
	};

	$(document).on('click', '#wall-post', function () {
		VK.api('account.getAppPermissions', function (data) {
			if (!(data.response & rights.wall)) {
				var onSettingsChanged = function(settings){ 
					if (!(settings & rights.wall)) {
						alert('Очень жаль');
					} else {
						wallPost();
					}
					VK.removeCallback('onSettingsChanged', onSettingsChanged);
				}
				VK.callMethod('showSettingsBox', rights.wall);
				VK.addCallback('onSettingsChanged', onSettingsChanged);
			} else {
				wallPost();
			}
		});
	})


}, function() { window.location.reload(true); }, '5.63');
});
</script>
</body>
</html>